@*
 * Copyright 2021 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import views.html.templates.Layout
@import views.html.templates.helpers.Button
@import views.html.templates.helpers.Heading
@import utils.ViewUtils.summaryListRow
@import models.benefits.BenefitsViewModel
@import utils.ViewUtils.bigDecimalCurrency

@import controllers.benefits.routes._
@import controllers.benefits.accommodation.routes._
@import controllers.benefits.assets.routes._
@import controllers.benefits.fuel.routes._
@import controllers.benefits.income.routes._
@import controllers.benefits.medical.routes._
@import controllers.benefits.reimbursed.routes._
@import controllers.benefits.travel.routes._
@import controllers.benefits.utilities.routes._

@import controllers.employment.routes._

@this(
    layout: Layout,
    formWithCSRF: FormWithCSRF,
    button: Button,
    heading: Heading,
    govukSummaryList: GovukSummaryList
)

@(taxYear: Int, benefits: BenefitsViewModel, employmentId: String, isUsingCustomerData: Boolean)(implicit user: User[_], messages: Messages, appConfig: AppConfig)

@headingForUse = @{messages(s"checkYourBenefits.heading.${if(user.isAgent) "agent" else "individual"}")}

@titleForUse = @{messages(s"checkYourBenefits.heading.${if(user.isAgent) "agent" else "individual"}")}

@hiddenText(item:String) = @{Some(messages(s"$item.hiddenText.${if(user.isAgent) "agent" else "individual"}"))}

@showRows(item: String, value: BigDecimal, route: Call = CheckYourBenefitsController.show(taxYear, employmentId)) = @{
    summaryListRow(HtmlContent(messages(item)),HtmlContent(bigDecimalCurrency(value.toString)),actions = Seq((route, messages("common.change"), hiddenText(item))), keyClasses="govuk-!-width-two-thirds")
}

@showQuestionRow(item: String, value: Boolean, route: Call = CheckYourBenefitsController.show(taxYear, employmentId)) = @{
    summaryListRow(HtmlContent(messages(item)),HtmlContent(if(value){messages("common.yes")} else {messages("common.no")}),actions = Seq((route, messages("common.change"), hiddenText(item))), keyClasses="govuk-!-width-two-thirds")
}

@layout(pageTitle = titleForUse, taxYear = Some(taxYear)) {

    @heading(headingForUse, Some(messages("employment.caption", (taxYear - 1).toString, taxYear.toString)), "govuk-!-margin-bottom-5")

    @if(!isUsingCustomerData){
        <p class="govuk-body">@messages(s"checkYourBenefits.p1.${if(user.isAgent) "agent" else "individual"}")</p>
    }

    @govukSummaryList(SummaryList(Seq(showQuestionRow("checkYourBenefits.benefitsReceived", benefits.isBenefitsReceived, ReceiveAnyBenefitsController.show(taxYear, employmentId)))))

    @if(benefits.isBenefitsReceived){

    <h2 class="govuk-label--m">@messages("checkYourBenefits.vehicleHeader")</h2>
        @{
            val header: Seq[SummaryListRow] = Seq(showQuestionRow("checkYourBenefits.carSubheading", benefits.carVanFuelModel.flatMap(_.sectionQuestion).getOrElse(false), CarVanFuelBenefitsController.show(taxYear, employmentId)))
            val rows: Seq[SummaryListRow] =
                Seq(
                    benefits.carVanFuelModel.flatMap(_.carQuestion).map{
                        carQuestion => showQuestionRow("checkYourBenefits.companyCar", carQuestion, CompanyCarBenefitsController.show(taxYear, employmentId))
                    },
                    benefits.carVanFuelModel.flatMap(_.car).map{
                        car => showRows("checkYourBenefits.companyCarAmount", car, CompanyCarBenefitsAmountController.show(taxYear, employmentId))
                    },
                    benefits.carVanFuelModel.flatMap(_.carFuelQuestion).map{
                        carFuelQuestion => showQuestionRow("checkYourBenefits.fuelForCompanyCar", carFuelQuestion, CompanyCarFuelBenefitsController.show(taxYear, employmentId))
                    },
                    benefits.carVanFuelModel.flatMap(_.carFuel).map{
                        carFuel => showRows("checkYourBenefits.fuelForCompanyCarAmount", carFuel, CarFuelBenefitsAmountController.show(taxYear, employmentId))
                    },
                    benefits.carVanFuelModel.flatMap(_.vanQuestion).map{
                        vanQuestion => showQuestionRow("checkYourBenefits.companyVan", vanQuestion, CompanyVanBenefitsController.show(taxYear, employmentId))
                    },
                    benefits.carVanFuelModel.flatMap(_.van).map{
                        van => showRows("checkYourBenefits.companyVanAmount", van, CompanyVanBenefitsAmountController.show(taxYear, employmentId))
                    },
                    benefits.carVanFuelModel.flatMap(_.vanFuelQuestion).map{
                        vanFuelQuestion => showQuestionRow("checkYourBenefits.fuelForCompanyVan", vanFuelQuestion, CompanyVanFuelBenefitsController.show(taxYear, employmentId))
                    },
                    benefits.carVanFuelModel.flatMap(_.vanFuel).map{
                        vanFuel => showRows("checkYourBenefits.fuelForCompanyVanAmount", vanFuel, CompanyVanFuelBenefitsAmountController.show(taxYear, employmentId))
                    },
                    benefits.carVanFuelModel.flatMap(_.mileageQuestion).map{
                        mileageQuestion => showQuestionRow("checkYourBenefits.mileageBenefit", mileageQuestion, ReceiveOwnCarMileageBenefitController.show(taxYear, employmentId))
                    },
                    benefits.carVanFuelModel.flatMap(_.mileage).map{
                        mileage => showRows("checkYourBenefits.mileageBenefitAmount", mileage, MileageBenefitAmountController.show(taxYear, employmentId))
                    }
                ).flatten

            govukSummaryList(SummaryList(header ++ rows))
    }

    <h2 class="govuk-label--m">@messages("checkYourBenefits.accommodationHeader")</h2>
    @{
        val header: Seq[SummaryListRow] = Seq(showQuestionRow("checkYourBenefits.accommodationSubheading", benefits.accommodationRelocationModel.flatMap(_.sectionQuestion).getOrElse(false), AccommodationRelocationBenefitsController.show(taxYear, employmentId)))
        val rows: Seq[SummaryListRow] =
            Seq(
                benefits.accommodationRelocationModel.flatMap(_.accommodationQuestion).map{
                    accommodationQuestion => showQuestionRow("checkYourBenefits.accommodation", accommodationQuestion, LivingAccommodationBenefitsController.show(taxYear, employmentId))
                },
                benefits.accommodationRelocationModel.flatMap(_.accommodation).map{
                    accommodation => showRows("checkYourBenefits.accommodationAmount", accommodation, LivingAccommodationBenefitAmountController.show(taxYear, employmentId))
                },
                benefits.accommodationRelocationModel.flatMap(_.qualifyingRelocationExpensesQuestion).map{
                    qualifyingRelocationExpensesQuestion => showQuestionRow("checkYourBenefits.qualifyingRelocationCosts", qualifyingRelocationExpensesQuestion, QualifyingRelocationBenefitsController.show(taxYear, employmentId))
                },
                benefits.accommodationRelocationModel.flatMap(_.qualifyingRelocationExpenses).map{
                    qualifyingRelocationExpenses => showRows("checkYourBenefits.qualifyingRelocationCostsAmount", qualifyingRelocationExpenses, QualifyingRelocationBenefitsAmountController.show(taxYear, employmentId))
                },
                benefits.accommodationRelocationModel.flatMap(_.nonQualifyingRelocationExpensesQuestion).map{
                    nonQualifyingRelocationExpensesQuestion => showQuestionRow("checkYourBenefits.nonQualifyingRelocationCosts", nonQualifyingRelocationExpensesQuestion, NonQualifyingRelocationBenefitsController.show(taxYear, employmentId))
                },
                benefits.accommodationRelocationModel.flatMap(_.nonQualifyingRelocationExpenses).map{
                    nonQualifyingRelocationExpenses => showRows("checkYourBenefits.nonQualifyingRelocationCostsAmount",
                        nonQualifyingRelocationExpenses, NonQualifyingRelocationBenefitsAmountController.show(taxYear, employmentId))
                }
            ).flatten

        govukSummaryList(SummaryList(header ++ rows))
    }

    <h2 class="govuk-label--m">@messages("checkYourBenefits.travelHeader")</h2>
    @{
        val header: Seq[SummaryListRow] = Seq(showQuestionRow("checkYourBenefits.travelSubheading", benefits.travelEntertainmentModel.flatMap(_.sectionQuestion).getOrElse(false), TravelOrEntertainmentBenefitsController.show(taxYear, employmentId)))
        val rows: Seq[SummaryListRow] =
            Seq(
                benefits.travelEntertainmentModel.flatMap(_.travelAndSubsistenceQuestion).map{
                    travelAndSubsistenceQuestion => showQuestionRow("checkYourBenefits.travelAndSubsistence", travelAndSubsistenceQuestion, TravelAndSubsistenceBenefitsController.show(taxYear, employmentId))
                },
                benefits.travelEntertainmentModel.flatMap(_.travelAndSubsistence).map{
                    travelAndSubsistence => showRows("checkYourBenefits.travelAndSubsistenceAmount", travelAndSubsistence, TravelOrSubsistenceBenefitsAmountController.show(taxYear, employmentId))
                },
                benefits.travelEntertainmentModel.flatMap(_.personalIncidentalExpensesQuestion).map{
                    personalIncidentalExpensesQuestion => showQuestionRow("checkYourBenefits.personalCosts", personalIncidentalExpensesQuestion,IncidentalOvernightCostEmploymentBenefitsController.show(taxYear, employmentId))
                },
                benefits.travelEntertainmentModel.flatMap(_.personalIncidentalExpenses).map{
                    personalIncidentalExpenses => showRows("checkYourBenefits.personalCostsAmount", personalIncidentalExpenses, IncidentalCostsBenefitsAmountController.show(taxYear, employmentId))
                },
                benefits.travelEntertainmentModel.flatMap(_.entertainingQuestion).map{
                    entertainingQuestion => showQuestionRow("checkYourBenefits.entertainment", entertainingQuestion, EntertainingBenefitsController.show(taxYear, employmentId))
                },
                benefits.travelEntertainmentModel.flatMap(_.entertaining).map{
                    entertaining => showRows("checkYourBenefits.entertainmentAmount", entertaining, EntertainmentBenefitsAmountController.show(taxYear, employmentId))
                }
            ).flatten

        govukSummaryList(SummaryList(header ++ rows))
    }

    <h2 class="govuk-label--m">@messages("checkYourBenefits.utilitiesHeader")</h2>
    @{
        val header: Seq[SummaryListRow] = Seq(showQuestionRow("checkYourBenefits.utilitiesSubheading", benefits.utilitiesAndServicesModel.flatMap(_.sectionQuestion).getOrElse(false), UtilitiesOrGeneralServicesBenefitsController.show(taxYear, employmentId)))
        val rows: Seq[SummaryListRow] =
            Seq(
                benefits.utilitiesAndServicesModel.flatMap(_.telephoneQuestion).map{
                    telephoneQuestion => showQuestionRow("checkYourBenefits.telephone", telephoneQuestion, TelephoneBenefitsController.show(taxYear: Int, employmentId: String))
                },
                benefits.utilitiesAndServicesModel.flatMap(_.telephone).map{
                    telephone => showRows("checkYourBenefits.telephoneAmount", telephone, TelephoneEmploymentBenefitsAmountController.show(taxYear, employmentId))
                },
                benefits.utilitiesAndServicesModel.flatMap(_.employerProvidedServicesQuestion).map{
                    employerProvidedServicesQuestion => showQuestionRow("checkYourBenefits.servicesProvided", employerProvidedServicesQuestion, EmployerProvidedServicesBenefitsController.show(taxYear: Int, employmentId: String))
                },
                benefits.utilitiesAndServicesModel.flatMap(_.employerProvidedServices).map{
                    employerProvidedServices => showRows("checkYourBenefits.servicesProvidedAmount", employerProvidedServices, EmployerProvidedServicesBenefitsAmountController.show(taxYear, employmentId))
                },
                benefits.utilitiesAndServicesModel.flatMap(_.employerProvidedProfessionalSubscriptionsQuestion).map{
                    employerProvidedProfessionalSubscriptionsQuestion => showQuestionRow("checkYourBenefits.profSubscriptions", employerProvidedProfessionalSubscriptionsQuestion, ProfessionalSubscriptionsBenefitsController.show(taxYear, employmentId))
                },
                benefits.utilitiesAndServicesModel.flatMap(_.employerProvidedProfessionalSubscriptions).map{
                    employerProvidedProfessionalSubscriptions => showRows("checkYourBenefits.profSubscriptionsAmount", employerProvidedProfessionalSubscriptions, ProfessionalSubscriptionsBenefitsAmountController.show(taxYear, employmentId))
                },
                benefits.utilitiesAndServicesModel.flatMap(_.serviceQuestion).map{
                    serviceQuestion => showQuestionRow("checkYourBenefits.otherServices", serviceQuestion, OtherServicesBenefitsController.show(taxYear, employmentId))
                },
                benefits.utilitiesAndServicesModel.flatMap(_.service).map{
                    service => showRows("checkYourBenefits.otherServicesAmount", service, OtherServicesBenefitsAmountController.show(taxYear, employmentId))
                }
            ).flatten

        govukSummaryList(SummaryList(header ++ rows))
    }

    <h2 class="govuk-label--m">@messages("checkYourBenefits.medicalHeader")</h2>
    @{
        val header: Seq[SummaryListRow] = Seq(showQuestionRow("checkYourBenefits.medicalSubheading", benefits.medicalChildcareEducationModel.flatMap(_.sectionQuestion).getOrElse(false), MedicalDentalChildcareBenefitsController.show(taxYear, employmentId)))
        val rows: Seq[SummaryListRow] =
            Seq(
                benefits.medicalChildcareEducationModel.flatMap(_.medicalInsuranceQuestion).map{
                    medicalInsuranceQuestion => showQuestionRow("checkYourBenefits.medicalIns", benefits.medicalChildcareEducationModel.flatMap(_.medicalInsuranceQuestion).getOrElse(false), MedicalDentalBenefitsController.show(taxYear, employmentId))
                },
                benefits.medicalChildcareEducationModel.flatMap(_.medicalInsurance).map{
                    medicalInsurance => showRows("checkYourBenefits.medicalInsAmount", medicalInsurance, MedicalOrDentalBenefitsAmountController.show(taxYear, employmentId))
                },
                benefits.medicalChildcareEducationModel.flatMap(_.nurseryPlacesQuestion).map{
                    nurseryPlacesQuestion => showQuestionRow("checkYourBenefits.nursery", nurseryPlacesQuestion, ChildcareBenefitsController.show(taxYear, employmentId))
                },
                benefits.medicalChildcareEducationModel.flatMap(_.nurseryPlaces).map{
                    nurseryPlaces => showRows("checkYourBenefits.nurseryAmount", nurseryPlaces, ChildcareBenefitsAmountController.show(taxYear, employmentId))
                },
                benefits.medicalChildcareEducationModel.flatMap(_.educationalServicesQuestion).map{
                    educationalServicesQuestion => showQuestionRow("checkYourBenefits.educational", educationalServicesQuestion, EducationalServicesBenefitsController.show(taxYear, employmentId))
                },
                benefits.medicalChildcareEducationModel.flatMap(_.educationalServices).map{
                    educationalServices => showRows("checkYourBenefits.educationalAmount", educationalServices, EducationalServicesBenefitsAmountController.show(taxYear, employmentId))
                },
                benefits.medicalChildcareEducationModel.flatMap(_.beneficialLoanQuestion).map{
                    beneficialLoanQuestion => showQuestionRow("checkYourBenefits.beneficialLoans", beneficialLoanQuestion, BeneficialLoansBenefitsController.show(taxYear: Int, employmentId: String))
                },
                benefits.medicalChildcareEducationModel.flatMap(_.beneficialLoan).map{
                    beneficialLoan => showRows("checkYourBenefits.beneficialLoansAmount", beneficialLoan, BeneficialLoansAmountController.show(taxYear: Int, employmentId: String))
                }
            ).flatten

        govukSummaryList(SummaryList(header ++ rows))
    }

    <h2 class="govuk-label--m">@messages("checkYourBenefits.incomeTaxHeader")</h2>
    @{
        val header: Seq[SummaryListRow] = Seq(showQuestionRow("checkYourBenefits.incomeTaxSubheading", benefits.incomeTaxAndCostsModel.flatMap(_.sectionQuestion).getOrElse(false), IncomeTaxOrIncurredCostsBenefitsController.show(taxYear, employmentId)))
        val rows: Seq[SummaryListRow] =
        if(benefits.incomeTaxDetailsPopulated){
            Seq(
                benefits.incomeTaxAndCostsModel.flatMap(_.incomeTaxPaidByDirectorQuestion).map{
                    incomeTaxPaidByDirectorQuestion => showQuestionRow("checkYourBenefits.incomeTaxPaid", incomeTaxPaidByDirectorQuestion, IncomeTaxBenefitsController.show(taxYear, employmentId))
                },
                benefits.incomeTaxAndCostsModel.flatMap(_.incomeTaxPaidByDirector).map{
                    incomeTaxPaidByDirector => showRows("checkYourBenefits.incomeTaxPaidAmount", incomeTaxPaidByDirector, IncomeTaxBenefitsAmountController.show(taxYear, employmentId))
                },
                benefits.incomeTaxAndCostsModel.flatMap(_.paymentsOnEmployeesBehalfQuestion).map{
                    paymentsOnEmployeesBehalfQuestion => showQuestionRow("checkYourBenefits.incurredCostsPaid", paymentsOnEmployeesBehalfQuestion, IncurredCostsBenefitsController.show(taxYear, employmentId))
                },
                benefits.incomeTaxAndCostsModel.flatMap(_.paymentsOnEmployeesBehalf).map{
                    paymentsOnEmployeesBehalf => showRows("checkYourBenefits.incurredCostsPaidAmount", paymentsOnEmployeesBehalf, IncurredCostsBenefitsAmountController.show(taxYear, employmentId))
                }
            ).flatten
        } else { Seq() }

        govukSummaryList(SummaryList(header ++ rows))
    }

    <h2 class="govuk-label--m">@messages("checkYourBenefits.reimbursedHeader")</h2>
    @{
        val header: Seq[SummaryListRow] = Seq(showQuestionRow("checkYourBenefits.reimbursedSubheading", benefits.reimbursedCostsVouchersAndNonCashModel.flatMap(_.sectionQuestion).getOrElse(false), ReimbursedCostsVouchersAndNonCashBenefitsController.show(taxYear, employmentId)))
        val rows: Seq[SummaryListRow] =
        if(benefits.reimbursedDetailsPopulated){
            Seq(
                benefits.reimbursedCostsVouchersAndNonCashModel.flatMap(_.expensesQuestion).map{
                    expensesQuestion => showQuestionRow("checkYourBenefits.nonTaxable", expensesQuestion, NonTaxableCostsBenefitsController.show(taxYear,employmentId))
                },
                benefits.reimbursedCostsVouchersAndNonCashModel.flatMap(_.expenses).map{
                    expenses => showRows("checkYourBenefits.nonTaxableAmount", expenses, NonTaxableCostsBenefitsAmountController.show(taxYear, employmentId))
                },
                benefits.reimbursedCostsVouchersAndNonCashModel.flatMap(_.taxableExpensesQuestion).map{
                    taxableExpensesQuestion => showQuestionRow("checkYourBenefits.taxableCosts", taxableExpensesQuestion, TaxableCostsBenefitsController.show(taxYear, employmentId))
                },
                benefits.reimbursedCostsVouchersAndNonCashModel.flatMap(_.taxableExpenses).map{
                    taxableExpenses => showRows("checkYourBenefits.taxableCostsAmount", taxableExpenses, TaxableCostsBenefitsAmountController.show(taxYear, employmentId))
                },
                benefits.reimbursedCostsVouchersAndNonCashModel.flatMap(_.vouchersAndCreditCardsQuestion).map{
                    vouchersAndCreditCardsQuestion => showQuestionRow("checkYourBenefits.vouchers", vouchersAndCreditCardsQuestion, VouchersBenefitsController.show(taxYear, employmentId))
                },
                benefits.reimbursedCostsVouchersAndNonCashModel.flatMap(_.vouchersAndCreditCards).map{
                    vouchersAndCreditCards => showRows("checkYourBenefits.vouchersAmount", vouchersAndCreditCards, VouchersBenefitsAmountController.show(taxYear, employmentId))
                },
                benefits.reimbursedCostsVouchersAndNonCashModel.flatMap(_.nonCashQuestion).map{
                    nonCashQuestion => showQuestionRow("checkYourBenefits.nonCash", nonCashQuestion)
                },
                benefits.reimbursedCostsVouchersAndNonCashModel.flatMap(_.nonCash).map{
                    nonCash => showRows("checkYourBenefits.nonCashAmount", nonCash, NonCashBenefitsAmountController.show(taxYear, employmentId))
                },
                benefits.reimbursedCostsVouchersAndNonCashModel.flatMap(_.otherItemsQuestion).map{
                    otherItemsQuestion => showQuestionRow("checkYourBenefits.otherBenefits", otherItemsQuestion)
                },
                benefits.reimbursedCostsVouchersAndNonCashModel.flatMap(_.otherItems).map{
                    otherItems => showRows("checkYourBenefits.otherBenefitsAmount", otherItems, OtherBenefitsAmountController.show(taxYear, employmentId))
                }
            ).flatten
        } else { Seq() }

        govukSummaryList(SummaryList(header ++ rows))
    }

    <h2 class="govuk-label--m">@messages("checkYourBenefits.assetsHeader")</h2>
    @{
        val header: Seq[SummaryListRow] = Seq(showQuestionRow("checkYourBenefits.assetsSubheading", benefits.assetsModel.flatMap(_.sectionQuestion).getOrElse(false), AssetsOrAssetTransfersBenefitsController.show(taxYear, employmentId)))
        val rows: Seq[SummaryListRow] =
        if(benefits.assetsDetailsPopulated){
            Seq(
                benefits.assetsModel.flatMap(_.assetsQuestion).map{
                    assetsQuestion => showQuestionRow("checkYourBenefits.assets", assetsQuestion, AssetsBenefitsController.show(taxYear, employmentId))
                },
                benefits.assetsModel.flatMap(_.assets).map{
                    assets => showRows("checkYourBenefits.assetsAmount", assets, AssetsBenefitsAmountController.show(taxYear, employmentId))
                },
                benefits.assetsModel.flatMap(_.assetTransferQuestion).map{
                    assetTransferQuestion => showQuestionRow("checkYourBenefits.assetTransfers", assetTransferQuestion)
                },
                benefits.assetsModel.flatMap(_.assetTransfer).map{
                    assetTransfer => showRows("checkYourBenefits.assetTransfersAmount", assetTransfer)
                }
            ).flatten
        } else { Seq() }

        govukSummaryList(SummaryList(header ++ rows))
    }

    }

    @button("common.saveAndContinue", classes = Some("govuk-!-margin-top-6"))
}

@{
// $COVERAGE-OFF$
}
